<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TOEIC Island</title>
  <style>
    body {
      margin: 0;
      font-family: "Microsoft JhengHei", sans-serif;
      background: #f2f7fb;
      color: #333;
      overflow-x: hidden;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 10px 20px;
      flex-wrap: wrap;
    }
    .player-info {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      flex-wrap: wrap;
    }
    .player-info img.avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ddd;
      cursor: pointer;
    }
    .player-name {
      font-weight: bold;
      font-size: 18px;
    }
    .rename-icon {
      width: 22px;
      height: 22px;
      cursor: pointer;
      vertical-align: middle;
    }
    .level-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .level {
      font-size: 14px;
    }
    .level-bar {
      width: 100px;
      height: 8px;
      background: #ddd;
      border-radius: 5px;
      overflow: hidden;
      margin-left: 5px;
      display: inline-block;
      vertical-align: middle;
    }
    .level-bar-fill {
      height: 100%;
      width: 0%; 
      background: #4caf50;
      transition: width 0.3s;
    }
    .help-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: transform 0.2s;
    }
    .help-btn:hover {
      background: #f8f8f8;
      transform: scale(1.1);
    }

    /* 資源列 */
    .resources {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .resource {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 16px;
    }
    .resource img {
      width: 24px;
      height: 24px;
    }

    main {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 10px;
    }

    /* 電腦版：左右分欄布局 */
    .game-content {
      display: flex;
      gap: 30px;
      max-width: 1200px;
      width: 100%;
      align-items: flex-start;
    }

    /* 左側島嶼圖片容器 */
    .island-container {
      position: relative;
      flex: 1;
      max-width: 500px; /* 限制最大寬度，避免過大 */
      border-radius: 20px;
      overflow: hidden;
      display: flex; /* 使用 flexbox 讓圖片居中 */
      justify-content: center; /* 水平居中 */
      align-items: center; /* 垂直居中 */
      background-color: #FFFFFF; /* 如果圖片非方形，背景色可填補空白 */
    }
    .island-container img {
      width: auto; /* 寬度自動 */
      height: auto; /* 高度自動 */
      max-width: 100%; /* 圖片最大寬度不超過容器 */
      max-height: 100%; /* 圖片最大高度不超過容器 */
      display: block; /* 移除圖片底部的空白 */
      object-fit: contain; /* 確保圖片完整顯示，不裁切 */
      /* object-fit: cover; */ /* 先前造成裁切的樣式 */
    }

    /* 右側城區矩陣 */
    .cities-section {
      width: 100%;
      max-width: 500px;  /* 跟島嶼圖同一個 max-width */
      margin: 0 auto;    /* 讓它置中 */
    }

    /* 城區矩陣 */
    .city-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr); /* 固定4欄 */
      gap: 15px;
      width: 100%;       /* 滿版佔據 cities-section */
      margin-bottom: 20px;
    }
    
    /* 新的城區按鈕樣式 */
    .city-button {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 90px;
      background: linear-gradient(135deg, #a8dadc, #457b9d);
      color: white;
      text-decoration: none;
      border-radius: 12px;
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: transform 0.2s, background 0.2s, box-shadow 0.2s;
      cursor: pointer;
      border: none;
      padding: 5px;
      text-align: center;
      white-space: normal;
      overflow: hidden;
    }
    .city-button:hover {
      transform: translateY(-3px) scale(1.02);
      background: linear-gradient(135deg, #FFD700, #FFA07A);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    .city-button span.city-name {
      font-size: 1.1em;
      line-height: 1.2;
    }
    .city-button span.city-level {
      font-size: 0.85em;
      margin-top: 3px;
      opacity: 0.9;
    }

    /* 測試按鈕容器 */
    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px auto;
      flex-wrap: wrap;
    }

    /* 測試和重置按鈕樣式 */
    .action-buttons .btn {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      min-width: 120px;
    }
    .action-buttons .btn-test {
      background: #4caf50;
      color: white;
    }
    .action-buttons .btn-test:hover {
      background: #45a049;
      transform: translateY(-2px);
    }
    .action-buttons .btn-reset {
      background: #f44336;
      color: white;
    }
    .action-buttons .btn-reset:hover {
      background: #d32f2f;
      transform: translateY(-2px);
    }

    footer {
      text-align: center;
      font-size: 12px;
      color: #777;
      padding: 20px 10px;
    }

    /* 響應式：手機時調整為縱向排列，字體加大 */
    @media (max-width: 968px) {
      .game-content {
        flex-direction: column;
        gap: 20px;
      }
      
      .island-container {
        max-width: 100%;
        height: auto !important; /* 手機版恢復自動高度 */
        aspect-ratio: 1 / 1; /* 保持正方形比例 */
      }
      
      .cities-section {
        max-width: 100%;
      }
    }

    @media (max-width: 768px) {
      .city-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }
      .city-button {
        height: 80px;
        font-size: 16px;
      }
      .city-button span.city-name {
        font-size: 1.0em;
      }
      .city-button span.city-level {
        font-size: 0.85em;
      }
      .action-buttons .btn {
        padding: 10px 18px;
        font-size: 15px;
        min-width: 110px;
      }
    }

    @media (max-width: 480px) {
      .island-container {
        width: 100%;
        border-radius: 12px;
      }
      
      .cities-section {
        width: 100%;
      }
      
      .city-button {
        height: 75px;
        font-size: 15px;
      }
      .city-button span.city-name {
        font-size: 0.95em;
      }
      .city-button span.city-level {
        font-size: 0.8em;
      }
    }

    /* 說明視窗 */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      max-width: 500px;
      text-align: left;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
      font-weight: bold;
      font-size: 24px;
      color: #777;
    }
    .modal-close:hover {
        color: #333;
    }
  </style>
</head>
<body>
  <header>
    <div class="player-info">
		<label for="avatarUpload">
		  <img src="img/avatar.png" alt="avatar" class="avatar" id="avatarImg">
		</label>
		<input type="file" id="avatarUpload" accept="image/*" style="display:none">
      <span class="player-name" id="playerName">島主</span>
      <img src="img/rename.png" class="rename-icon" alt="rename" id="renameBtn">
      <div class="level-container">
        <div class="level">LV: <span id="playerLevel">1</span>
          <div class="level-bar"><div class="level-bar-fill" id="levelBar"></div></div>
        </div>
        <button class="help-btn">?</button>

      </div>
    </div>

    <div class="resources">
      <div class="resource"><img src="img/gems/gem_fire.png"><span>0</span></div>
      <div class="resource"><img src="img/gems/gem_water.png"><span>0</span></div>
      <div class="resource"><img src="img/gems/gem_earth.png"><span>0</span></div>
      <div class="resource"><img src="img/gems/gem_wind.png"><span>0</span></div>
    </div>
  </header>

  <main>
    <div class="game-content">
      <div class="island-container">
        <img src="img/island_LV01.jpeg" alt="island" id="island-img">
      </div>

      <div class="cities-section">
        <div class="city-grid" id="cityGrid"></div>
        
        <div class="action-buttons">
          <button class="btn btn-test" id="testLevelBtn">📈 測試升級</button>
          <button class="btn btn-reset" id="resetProgressBtn">🔄 重置進度</button>
        </div>
      </div>
    </div>
  </main>

  <footer>
    Copyright © 2025 Comibast All Rights Reserved
  </footer>

  <div class="modal" id="helpModal">
    <div class="modal-content">
      <span class="modal-close" id="closeModal">&times;</span>
      <h3>玩法說明</h3>
      <p>
        ˙TOEIC單字依照類別分成20區，點選城區進行拼字遊戲。<br>
        ˙每次4個單字，答對一字25分，滿分100分。<br>
        ˙可以使用提示下一個字母的功能，每用一次扣一分。<br>
        ˙分數會轉化成經驗值，提升城區等級。<br>
        ˙玩家等級為全島城區等級的平均值（四捨五入）。<br>
        ˙每升10級，主島的模樣會進化，從簡單可愛，變得華麗精緻！
      </p>
    </div>
  </div>

  <script>
    // 城區名稱
    const cities = [
      "住宿交通", "餐飲觀光", "行銷銷售", "調查研究", "社會財經",
      "部門組織", "招募薪資", "績效訓練", "購物訂單", "售後服務",
      "經營管理", "生產製造", "辦公溝通", "行政會議", "設備研發",
      "金融財務", "房屋修繕", "傳媒出版", "藝文活動", "健康生活"
    ];

    // 預設值
    let playerLevel = 1;
    let playerExp = 0; // 玩家經驗值，用於顯示進度條
    let cityLevels = new Array(20).fill(1);
    let playerName = "島主"; // 新增玩家名稱狀態
    let playerAvatar = "img/avatar.png"; // 預設頭像

    // 嘗試從 localStorage 載入資料
    function loadData() {
      const data = localStorage.getItem("toeicIslandSave");
      if (data) {
        const save = JSON.parse(data);
        playerLevel = save.playerLevel || 1;
        playerExp = save.playerExp || 0;
        cityLevels = save.cityLevels || new Array(20).fill(1);
        playerName = save.playerName || "島主";
        playerAvatar = save.playerAvatar || "img/avatar.png"; // 載入頭像 // 載入玩家名稱
      }
    }

    // 儲存資料到 localStorage
    function saveData() {
      const save = {
        playerLevel,
        playerExp,
        cityLevels,
        playerName,
        playerAvatar // 儲存頭像
      };
      localStorage.setItem("toeicIslandSave", JSON.stringify(save));
    }

    // 產生城區矩陣 (更新為按鈕樣式)
    function renderCities() {
      const grid = document.getElementById("cityGrid");
      grid.innerHTML = "";
      cities.forEach((name, i) => {
        const level = cityLevels[i];
        const filename = (i+1).toString().padStart(2,"0") + name + ".html";
        
        const button = document.createElement("a"); // 使用a標籤模擬按鈕，方便跳轉
        button.href = filename;
        button.className = "city-button";
        button.innerHTML = `
          <span class="city-name">${name}</span>
          <span class="city-level">LV${level}</span>
        `;
        grid.appendChild(button);
      });
    }

    // 玩家 UI 更新
    const playerLevelEl = document.getElementById('playerLevel');
    const levelBar = document.getElementById('levelBar');
    const islandImg = document.getElementById('island-img');
    const playerNameEl = document.getElementById('playerName'); // 獲取玩家名稱元素
    const islandContainer = document.querySelector('.island-container');
    const citiesSection = document.querySelector('.cities-section');
    const cityGrid = document.getElementById('cityGrid');


    function updateIsland(level) {
      if (level >= 30) islandImg.src = "img/island_LV30.jpeg";
      else if (level >= 20) islandImg.src = "img/island_LV20.jpeg";
      else if (level >= 10) islandImg.src = "img/island_LV10.jpeg";
      else islandImg.src = "img/island_LV01.jpeg";
    }

    function updateIslandHeight() {
      // 只有在電腦版（螢幕寬度大於 968px）才執行此邏輯
      if (window.innerWidth > 968) {
        // 確保 cityGrid 已經渲染完成，才能正確計算高度
        // 如果 grid 的 display 是 grid，其 offsetHeight 會包含 gap
        const totalHeight = cityGrid.offsetHeight;
        
        // 設定 islandContainer 的高度
        islandContainer.style.height = `${totalHeight}px`;

        // 調整 islandContainer 的寬度，讓其維持正方形，並與高度對應
        // 這裡我們假設圖片是正方形 (1024x1024)，所以寬度也應該是高度
        islandContainer.style.width = `${totalHeight}px`; 
        islandContainer.style.maxWidth = '500px'; // 保持最大寬度限制
      } else {
        // 手機版恢復自動高度和寬度，並保持正方形比例
        islandContainer.style.height = 'auto';
        islandContainer.style.width = 'auto';
      }
    }

    function updateUI() {
      playerNameEl.textContent = playerName; // 更新玩家名稱
      playerLevelEl.textContent = playerLevel;
      levelBar.style.width = (playerExp % 100) + "%"; // 假設每100點經驗升級
      avatarImg.src = playerAvatar; // 更新頭像
      updateIsland(playerLevel);
      renderCities();
      // 確保在所有 DOM 元素渲染完成後才計算高度
      requestAnimationFrame(updateIslandHeight); 
      saveData(); // 更新後立即存檔
    }

    // 測試升級按鈕 (已修正)
    const testBtn = document.getElementById('testLevelBtn');
    testBtn.addEventListener('click', () => {
      // 每次點擊增加10級，並將經驗條設為100%，以模擬等級提升
      playerLevel = Math.min(playerLevel + 10, 30); // 每次增加10級，最高30級
      playerExp = 100; // 模擬經驗條滿格

      // 20 城區同步升級
      cityLevels = cityLevels.map(lv => Math.min(lv + 10, 30)); // 每個城區也同步升級，最高30級
      updateUI();
    });

    // 重置進度按鈕
    const resetProgressBtn = document.getElementById('resetProgressBtn');
    resetProgressBtn.addEventListener('click', () => {
      if (confirm("確定要重置所有遊戲進度嗎？這將無法復原！")) {
        localStorage.removeItem("toeicIslandSave");
        location.reload(); // 重載頁面以回到初始狀態
      }
    });

    // 改名功能（限制最多 12 字）
    const renameBtn = document.getElementById('renameBtn');
    renameBtn.addEventListener('click', () => {
      const maxLength = 12;
      const newName = prompt(`請輸入新名稱（最多 ${maxLength} 字）：`, playerName);
      if (newName && newName.trim() !== "") {
        if (newName.trim().length > maxLength) {
          alert(`名稱不能超過 ${maxLength} 個字！`);
          return; // 超過長度就不更新
        }
        playerName = newName.trim(); // 更新玩家名稱變數
        updateUI(); // 更新UI並存檔
      }
    });

    // 上傳頭像功能
    const avatarImg = document.getElementById('avatarImg');
    const avatarUpload = document.getElementById('avatarUpload');

    avatarUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const maxSize = 2 * 1024 * 1024; // 限制 2MB
        if (file.size > maxSize) {
          alert("檔案過大，請選擇小於 2MB 的圖片！");
          avatarUpload.value = ""; // 清空檔案
          return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
          playerAvatar = event.target.result; // 存進變數
          avatarImg.src = playerAvatar;       // 更新畫面
          saveData();                         // 存檔
        };
        reader.readAsDataURL(file);
      }
    });


    // 說明視窗
    const helpBtn = document.querySelector('.help-btn');
    const helpModal = document.getElementById('helpModal');
    const closeModal = document.getElementById('closeModal');
    helpBtn.addEventListener('click', () => {
      helpModal.style.display = 'flex';
    });
    closeModal.addEventListener('click', () => {
      helpModal.style.display = 'none';
    });
    window.addEventListener('click', (e) => {
      if (e.target === helpModal) {
        helpModal.style.display = 'none';
      }
    });

    // 初始化
    loadData();
    updateUI();

    // 監聽視窗大小改變，以即時調整高度和寬度
    window.addEventListener('resize', updateIslandHeight);
  </script>
</body>
</html>